<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMART PLANNER - PERFIL</title>
  <link rel="stylesheet" href="../styles/perfil.css">
  <link rel="icon" href="../img/Logo.png">
</head>
<body>
  <header class="topbar">
    <a class="back" href="../views/home.html"><img src="../img/flecha-volver.png" width="25" height="25" alt=""></a>
    <div class="top-title">
      <h1>Mi Perfil</h1>
      <h4>Gestiona tu información de perfil</h4>
    </div>
  </header>
<main class="profile-wrap">
  <!-- LADO IZQUIERDO PERFIL -->
  <div class="profile-card">
    <form class="avatar" id="avatarForm">
      <img
          id="imgPerfil"
          src="../img/usuario-perfil.png"
          alt="Foto de perfil"
          style="border-radius: 50%; max-width: 150px; width: 100%; height: auto;"
        />
      <button id="btnCambiarFoto" class="avatar-btn" title="Cambiar foto">✎</button>
      <input type="file" id="inputFoto" accept="image/*" style="display:none" />
    </form>
    <h2 class="name">Name User</h2>
    <div class="email">nameuser@example.com</div>
        <div class="current-plan-section">
      <div class="plan-header">
        <i class="fas fa-crown plan-icon"></i>
        <h3>Plan Actual</h3>
      </div>
      
      <div class="plan-info" id="currentPlanInfo">
        <div class="plan-details">
          <div class="plan-name-badge">
            <span class="plan-name">Gratuito</span>
            <span class="plan-status active">Plan Activo</span>
          </div>
          <div class="plan-price">$0 COP/mes</div>
          <div class="plan-next-billing">
            <i class="fas fa-calendar-alt"></i>
            <span>Próximo cobro: Plan</span>
          </div>
        </div>
      </div>
            <div class="plan-actions">
        <button class="btn-plan primary" onclick="cambiarPlan()">
          <i class="fas fa-exchange-alt"></i>
          Cambiar Plan
        </button>
      </div>
    </div>
  </div>

  <!-- LADO DERECHO INFORMACIÓN -->
  <section class="info-card">
    <div class="info-header">
      <h3>Información Personal</h3>
    </div>
    <form id="profileForm" class="info-form">
      <div class="grid-2">
        <label>
          Nombre Completo
          <input
            type="text"
            id="nombre"
            value=""
            placeholder="Ingresa tu nuevo nombre de usuario"
            required
          />
        </label>
      </div>

      <div class="grid-2">
        <label>
          Nueva Contraseña
          <div class="input-icon">
            <input
              type="password"
              id="contrasena"
              placeholder="Ingresa tu nueva contraseña"
            />
            <button
              type="button"
              class="toggle-password"
              onclick="togglePassword('contrasena', this)"
              type="button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                viewBox="0 0 24 24"
                class="eye-open"
                style="display:none"
              >
                <path
                  d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"
                />
              </svg>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zM12 17c-2.8 0-5-2.2-5-5 0-.8.2-1.6.6-2.3l6.7 6.7c-.7.4-1.5.6-2.3.6zM12 7c2.8 0 5 2.2 5 5 0 .8-.2 1.6-.6 2.3l-6.7-6.7C10.4 7.2 11.2 7 12 7z"
                />
                <line
                  x1="2"
                  y1="2"
                  x2="22"
                  y2="22"
                  stroke="currentColor"
                  stroke-width="2"
                  class="eye-closed"
                />
              </svg>
            </button>
          </div>
        </label>

        <label>
          Confirmar Contraseña
          <div class="input-icon">
            <input
              type="password"
              id="confirmContrasena"
              placeholder="Confirma tu nueva contraseña"
            />
            <button
              type="button"
              class="toggle-password"
              onclick="togglePassword('confirmContrasena', this)"
              type="button"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                viewBox="0 0 24 24"
                class="eye-open"
                style="display:none"
              >
                <path
                  d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"
                />
              </svg>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zM12 17c-2.8 0-5-2.2-5-5 0-.8.2-1.6.6-2.3l6.7 6.7c-.7.4-1.5.6-2.3.6zM12 7c2.8 0 5 2.2 5 5 0 .8-.2 1.6-.6 2.3l-6.7-6.7C10.4 7.2 11.2 7 12 7z"
                />
                <line
                  x1="2"
                  y1="2"
                  x2="22"
                  y2="22"
                  stroke="currentColor"
                  stroke-width="2"
                  class="eye-closed"
                />
              </svg>
            </button>
          </div>
        </label>
      </div>

      <!-- Requisitos contraseña -->
      <div class="password-rules">
        <h4>Requisitos de la contraseña:</h4>
        <ul>
          <li>Mínimo 8 caracteres</li>
          <li>Al menos una letra mayúscula</li>
          <li>Al menos un número</li>
          <li>Al menos un carácter especial</li>
        </ul>
      </div>

      <div class="form-actions">
        <button type="button" id="logoutBtn" class="btn secondary">Cerrar Sesión</button>
        <button type="submit" class="btn primary">Guardar Cambios</button>
      </div>
    </form>
  </section>
</main>
  <script src="../js/mostrarContraseña.js"></script>
  <script src="../js/api/updateUser.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api';
    let usuarioActual = null;
    
    function cambiarPlan() {
        if (usuarioActual && usuarioActual.idUsuario) {
            localStorage.setItem('idUsuario', usuarioActual.idUsuario);
            window.location.href = 'planes.html';
        } else {
            alert('Error: No se pudo identificar el usuario');
        }
    }

    async function cargarPerfil() {
        const usuarioJSON = localStorage.getItem('usuario');
        if (!usuarioJSON) {
            alert("No hay usuario logueado");
            window.location.href = "../index.html";
            return;
        }

        try {
            const usuario = JSON.parse(usuarioJSON);
            usuarioActual = usuario;

            document.querySelector(".name").textContent = usuario.nombre;
            document.querySelector(".email").textContent = usuario.correoElectronico;

            if (usuario.foto) {
                // ✅ Si la foto no es una URL completa, agregar el servidor
                const fotoUrl = usuario.foto.startsWith('http') 
                    ? usuario.foto 
                    : `http://localhost:8080${usuario.foto}`;
                document.getElementById("imgPerfil").src = fotoUrl;
            }if (usuario.foto) {
                // ✅ Si la foto no es una URL completa, agregar el servidor
                const fotoUrl = usuario.foto.startsWith('http') 
                    ? usuario.foto 
                    : `http://localhost:8080${usuario.foto}`;
                document.getElementById("imgPerfil").src = fotoUrl;
            }

            // Traer suscripción activa
            const response = await fetch(`${API_URL}/suscripciones/usuario/${usuario.idUsuario}/activa`);
            
            if (response.ok) {
                const suscripcion = await response.json();
                actualizarInfoPlan(suscripcion);
            } else {
                // Plan gratuito por defecto
                actualizarInfoPlan(null);
            }

        } catch (error) {
            console.error("Error cargando perfil:", error);
            actualizarInfoPlan(null);
        }
    }

    function actualizarInfoPlan(suscripcion) {
        const planNameElement = document.querySelector('.plan-name');
        const planPriceElement = document.querySelector('.plan-price');
        const planStatusElement = document.querySelector('.plan-status');
        const planNextBillingElement = document.querySelector('.plan-next-billing span');
        const planIcon = document.querySelector('.plan-icon');
        
        if (suscripcion && suscripcion.estado === 'activa') {
            planNameElement.textContent = suscripcion.nombrePlan;
            planPriceElement.textContent = `$${Number(suscripcion.precio).toLocaleString()} COP/mes`;
            planStatusElement.textContent = 'Plan Activo';
            planStatusElement.className = 'plan-status active';
            
            const fechaFin = new Date(suscripcion.fechaFin);
            planNextBillingElement.textContent = `Próximo cobro: ${fechaFin.toLocaleDateString('es-ES')}`;
            
            // Cambiar icono según el plan
            planIcon.className = 'fas plan-icon';
            switch(suscripcion.nombrePlan) {
                case 'Personal':
                    planIcon.classList.add('fa-user-tie');
                    break;
                case 'Empresas Medianas':
                    planIcon.classList.add('fa-users');
                    break;
                case 'Empresas Grandes':
                    planIcon.classList.add('fa-building');
                    break;
                default:
                    planIcon.classList.add('fa-crown');
            }
        } else {
            // Plan gratuito
            planNameElement.textContent = 'Gratuito';
            planPriceElement.textContent = '$0 COP/mes';
            planStatusElement.textContent = 'Plan Gratuito';
            planStatusElement.className = 'plan-status free';
            planNextBillingElement.textContent = 'Sin próximo cobro';
            planIcon.className = 'fas fa-user plan-icon';
        }
    }

    document.addEventListener("DOMContentLoaded", cargarPerfil);
</script>
</body>
</html>


